@startuml ERD
title neochibu - ERD (Core)

skinparam linetype ortho

entity users {
  * id : bigint [PK]
  --
  wallet_address : varchar
  display_name : varchar
  is_anonymous : boolean
  created_at : datetime
}

entity rooms {
  * id : bigint [PK]
  --
  host_user_id : bigint [FK -> users.id]
  type : enum("human","ai","music")
  title : varchar
  description : text
  pricing_type : enum("free","per_entry","per_minute")
  price_amount : int
  capacity : int
  visibility_boost : int  // 上位表示用コイン消費によるブースト
  is_adult_only : boolean
  created_at : datetime
  status : enum("active","suspended","closed")
}

entity room_sessions {
  * id : bigint [PK]
  --
  room_id : bigint [FK -> rooms.id]
  user_id : bigint [FK -> users.id]
  tx_hash : varchar
  start_at : datetime
  end_at : datetime
  total_minutes : int
  amount_paid : int
}

entity ratings {
  * id : bigint [PK]
  --
  room_id : bigint [FK -> rooms.id]
  user_id : bigint [FK -> users.id]
  score : int // 1-5
  comment : text
  created_at : datetime
}

entity payments {
  * id : bigint [PK]
  --
  room_session_id : bigint [FK -> room_sessions.id]
  tx_hash : varchar
  token_address : varchar
  amount : int
  paid_at : datetime
  status : enum("pending","confirmed","failed")
}

entity products {
  * id : bigint [PK]
  --
  sku : varchar
  name : varchar
  category : varchar
  price : int
  stock : int
  is_adult_goods : boolean
  created_at : datetime
}

entity orders {
  * id : bigint [PK]
  --
  user_id : bigint [FK -> users.id]
  total_amount : int
  tx_hash : varchar
  created_at : datetime
  status : enum("pending","paid","shipped","cancelled")
}

entity order_items {
  * id : bigint [PK]
  --
  order_id : bigint [FK -> orders.id]
  product_id : bigint [FK -> products.id]
  qty : int
  unit_price : int
}

entity age_verifications {
  * id : bigint [PK]
  --
  user_id : bigint [FK -> users.id]
  method : enum("KYC","ZK")
  verified_at : datetime
  proof_ref : varchar // ZK proof参照 or KYC証跡
}

entity dao_proposals {
  * id : bigint [PK]
  --
  title : varchar
  description : text
  created_at : datetime
  status : enum("open","passed","rejected")
}

entity dao_votes {
  * id : bigint [PK]
  --
  proposal_id : bigint [FK -> dao_proposals.id]
  voter_user_id : bigint [FK -> users.id]
  choice : enum("yes","no","abstain")
  weight : numeric
  created_at : datetime
}

users ||--o{ rooms : "hosts"
rooms ||--o{ room_sessions
users ||--o{ room_sessions : "joins"
room_sessions ||--o{ payments
rooms ||--o{ ratings
users ||--o{ ratings
users ||--o{ orders
orders ||--o{ order_items
products ||--o{ order_items
users ||--o{ age_verifications
dao_proposals ||--o{ dao_votes
users ||--o{ dao_votes : "voters"

@enduml
